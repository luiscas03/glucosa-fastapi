<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1E1E1E">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Glucose ML Monitor v2.0</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Roboto', sans-serif;
            background: #1E1E1E;
            color: #FFFFFF;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }

        .screen {
            display: none;
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 80px;
        }

        .screen.active {
            display: block;
        }

        .header {
            background: #2C2C2C;
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 20px;
            font-weight: bold;
            color: #00FF00;
        }

        .session-badge {
            background: rgba(0, 255, 0, 0.2);
            color: #00FF00;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
        }

        .glucose-main {
            text-align: center;
            background: #2C2C2C;
            padding: 30px;
            border-radius: 16px;
            margin-bottom: 20px;
        }

        .glucose-value {
            font-size: 72px;
            font-weight: bold;
            color: #00FF00;
            font-family: 'Roboto Mono', monospace;
        }

        .glucose-unit {
            font-size: 24px;
            color: #B0B0B0;
        }

        .indicators {
            display: flex;
            justify-content: space-around;
            margin: 15px 0;
            flex-wrap: wrap;
            gap: 10px;
        }

        .indicator {
            font-size: 14px;
            color: #B0B0B0;
        }

        .indicator strong {
            color: #FFFFFF;
        }

        .chart-container {
            background: #2C2C2C;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            height: 300px;
            position: relative;
        }

        .chart-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #00FF00;
        }

        .sensor-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .footer-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #2C2C2C;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            padding: 10px;
            gap: 8px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.5);
        }

        .nav-btn {
            background: #333333;
            border: none;
            color: #FFFFFF;
            padding: 12px;
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .nav-btn:active {
            transform: scale(0.95);
            background: #4CAF50;
        }

        .btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin: 10px 0;
            transition: all 0.3s;
        }

        .btn:active {
            transform: scale(0.98);
            background: #45a049;
        }

        .btn-primary {
            background: #00FF00;
            color: #1E1E1E;
        }

        .btn-secondary {
            background: #666666;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #B0B0B0;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            background: #333333;
            border: 1px solid #444444;
            border-radius: 8px;
            color: #FFFFFF;
            font-size: 16px;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #00FF00;
        }

        .toggle-group {
            display: flex;
            gap: 10px;
        }

        .toggle-btn {
            flex: 1;
            padding: 12px;
            background: #333333;
            border: 2px solid #444444;
            border-radius: 8px;
            color: #FFFFFF;
            cursor: pointer;
            transition: all 0.3s;
        }

        .toggle-btn.active {
            background: #4CAF50;
            border-color: #4CAF50;
        }

        .card {
            background: #2C2C2C;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
        }

        .model-badge {
            display: inline-block;
            background: rgba(76, 175, 80, 0.2);
            color: #4CAF50;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            margin: 5px;
        }

        .result-main {
            text-align: center;
            padding: 30px;
        }

        .result-value {
            font-size: 64px;
            font-weight: bold;
            color: #00FF00;
        }

        .category-badge {
            display: inline-block;
            padding: 10px 25px;
            border-radius: 25px;
            font-size: 18px;
            font-weight: bold;
            margin: 15px 0;
        }

        .category-normal { background: #4CAF50; color: white; }
        .category-prediabetes { background: #FFC107; color: #1E1E1E; }
        .category-diabetes { background: #F44336; color: white; }

        .timeline {
            position: relative;
            padding-left: 40px;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #444444;
        }

        .timeline-item {
            position: relative;
            margin-bottom: 20px;
            padding: 15px;
            background: #2C2C2C;
            border-radius: 8px;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -32px;
            top: 20px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #00FF00;
            border: 2px solid #1E1E1E;
        }

        .timeline-time {
            font-size: 12px;
            color: #00FF00;
            font-family: 'Roboto Mono', monospace;
        }

        .timeline-desc {
            margin-top: 5px;
            color: #B0B0B0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #2C2C2C;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #00FF00;
        }

        .stat-label {
            font-size: 12px;
            color: #B0B0B0;
            margin-top: 5px;
        }

        .video-preview {
            width: 100%;
            max-width: 400px;
            height: 300px;
            background: #000000;
            border-radius: 12px;
            margin: 20px auto;
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #333333;
            border-radius: 4px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: #00FF00;
            width: 0%;
            transition: width 0.3s;
        }

        .sensor-card {
            background: #2C2C2C;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
        }

        .sensor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .sensor-status {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #F44336;
        }

        .sensor-status.active {
            background: #4CAF50;
        }

        .sensor-data {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .sensor-value {
            text-align: center;
            padding: 10px;
            background: #333333;
            border-radius: 8px;
        }

        .sensor-value-label {
            font-size: 12px;
            color: #B0B0B0;
        }

        .sensor-value-number {
            font-size: 20px;
            font-weight: bold;
            color: #00FF00;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #333333;
            border-top: 4px solid #00FF00;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .history-item {
            background: #2C2C2C;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-date {
            font-size: 12px;
            color: #B0B0B0;
        }

        .history-data {
            font-size: 16px;
            font-weight: bold;
            color: #00FF00;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }

        .badge-ml {
            background: rgba(0, 255, 0, 0.2);
            color: #00FF00;
        }

        .badge-spo2 {
            background: rgba(33, 150, 243, 0.2);
            color: #2196F3;
        }

        .section-title {
            font-size: 18px;
            font-weight: bold;
            margin: 20px 0 15px 0;
            color: #00FF00;
        }

        .api-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: #2C2C2C;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #4CAF50;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .recommendation {
            background: rgba(255, 193, 7, 0.1);
            border-left: 4px solid #FFC107;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        @media (max-width: 600px) {
            .glucose-value {
                font-size: 56px;
            }
            
            .chart-container {
                height: 250px;
            }
            
            .sensor-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

<!-- PANTALLA 1: MONITOR PRINCIPAL -->
<div id="screen-monitor" class="screen active">
    <div class="header">
        <h1>ü©∏ Glucose ML Monitor</h1>
        <div class="session-badge">üü¢ Sesi√≥n: <span id="session-duration">00:00</span></div>
    </div>

    <div class="glucose-main">
        <div class="glucose-value">137<span class="glucose-unit">mg/dL</span></div>
        <div style="color: #B0B0B0; margin-top: 10px;">√öltima actualizaci√≥n: <span id="last-update">Ahora</span></div>
    </div>

    <div class="indicators">
        <div class="indicator">SpO2: <strong id="spo2-display">98%</strong></div>
        <div class="indicator">FC: <strong id="fc-display">75 bpm</strong></div>
        <div class="indicator">Actividad: <strong>üèÉ ACTIVO</strong></div>
    </div>

    <div class="chart-container">
        <div class="chart-title">üìà Glucosa (√öltimas 24h)</div>
        <canvas id="glucoseChart"></canvas>
    </div>

    <div class="sensor-grid">
        <div class="chart-container">
            <div class="chart-title">üì± Aceler√≥metro (m/s¬≤)</div>
            <canvas id="accelChart"></canvas>
        </div>
        <div class="chart-container">
            <div class="chart-title">üîÑ Giroscopio (¬∞/s)</div>
            <canvas id="gyroChart"></canvas>
        </div>
    </div>

    <div class="footer-nav">
        <button class="nav-btn" onclick="showScreen('measurement')">üì∏<br>Medici√≥n</button>
        <button class="nav-btn" onclick="showScreen('evaluation')">üß¨<br>Eval ML</button>
        <button class="nav-btn" onclick="showScreen('history')">üìä<br>Historial</button>
        <button class="nav-btn" onclick="showScreen('session')">üìã<br>Registro</button>
    </div>
</div>

<!-- PANTALLA 2: NUEVA MEDICI√ìN -->
<div id="screen-measurement" class="screen">
    <div class="header">
        <button class="btn-secondary" onclick="showScreen('monitor')" style="background: none; border: none; color: #00FF00; cursor: pointer;">‚Üê Volver</button>
        <h1>üì∏ Nueva Medici√≥n</h1>
    </div>

    <div class="card">
        <h3>Medici√≥n de SpO2 y Frecuencia Card√≠aca</h3>
        <p style="color: #B0B0B0; margin: 10px 0;">Coloca tu dedo sobre la c√°mara trasera y el flash</p>
        
        <video id="videoPreview" class="video-preview" autoplay playsinline style="display: none;"></video>
        
        <div id="captureCountdown" style="text-align: center; padding: 40px; display: none;">
            <div style="font-size: 72px; font-weight: bold; color: #00FF00;" id="countdownNumber">10</div>
            <div style="color: #B0B0B0;">Manteniendo el dedo en la c√°mara...</div>
            <div class="progress-bar">
                <div class="progress-fill" id="captureProgress"></div>
            </div>
        </div>

        <div id="captureResults" style="display: none;">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="measured-spo2">--</div>
                    <div class="stat-label">SpO2 (%)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="measured-fc">--</div>
                    <div class="stat-label">FC (bpm)</div>
                </div>
            </div>
            <div style="text-align: center; color: #B0B0B0;">
                <p>Calidad de se√±al: <strong style="color: #4CAF50;">Alta</strong></p>
                <p id="measurement-time">--</p>
            </div>
        </div>

        <button class="btn btn-primary" id="btnStartCapture" onclick="startCapture()">üì∏ INICIAR CAPTURA</button>
        <button class="btn" id="btnSaveMeasurement" onclick="saveMeasurement()" style="display: none;">üíæ Guardar en Historial</button>
    </div>
</div>

<!-- PANTALLA 3: EVALUACI√ìN ML -->
<div id="screen-evaluation" class="screen">
    <div class="header">
        <button class="btn-secondary" onclick="showScreen('monitor')" style="background: none; border: none; color: #00FF00; cursor: pointer;">‚Üê Volver</button>
        <h1>üß¨ Evaluaci√≥n ML</h1>
    </div>

    <div class="api-status">
        <div class="status-dot"></div>
        <div style="flex: 1;">
            <div style="font-size: 12px; color: #B0B0B0;">Conectado a API</div>
            <div style="font-size: 10px; color: #666;">https://stringed-ericka-vertically.ngrok-free.dev</div>
        </div>
    </div>

    <div class="card">
        <h3 style="margin-bottom: 15px;">7 Modelos ML Cargados</h3>
        <span class="model-badge">‚úÖ XGBoost</span>
        <span class="model-badge">‚úÖ RandomForest</span>
        <span class="model-badge">‚úÖ LightGBM</span>
        <span class="model-badge">‚úÖ GradientBoosting</span>
        <span class="model-badge">‚úÖ Ridge</span>
        <span class="model-badge">‚úÖ Lasso</span>
        <span class="model-badge">‚úÖ ElasticNet</span>
    </div>

    <form id="evaluationForm">
        <div class="section-title">üìã DATOS PERSONALES</div>
        <div class="form-group">
            <label>Edad *</label>
            <input type="number" id="edad" min="18" max="100" value="45" required>
        </div>
        <div class="form-group">
            <label>Sexo *</label>
            <select id="sexo" required>
                <option value="M">Masculino</option>
                <option value="F">Femenino</option>
            </select>
        </div>

        <div class="section-title">‚öñÔ∏è DATOS ANTROPOM√âTRICOS</div>
        <div class="form-group">
            <label>Peso (kg) *</label>
            <input type="number" step="0.1" id="peso" value="78.5" required>
        </div>
        <div class="form-group">
            <label>Talla (m) *</label>
            <input type="number" step="0.01" id="talla" value="1.70" required>
        </div>
        <div class="form-group">
            <label>IMC (calculado autom√°ticamente)</label>
            <input type="number" step="0.1" id="imc" value="27.16" readonly style="background: #4d4d00;">
        </div>
        <div class="form-group">
            <label>Per√≠metro Cintura (cm) *</label>
            <input type="number" id="cintura" value="95" required>
        </div>

        <div class="section-title">üíì SIGNOS VITALES</div>
        <div class="form-group">
            <label>SpO2 (%)</label>
            <input type="number" id="eval-spo2" value="98">
        </div>
        <div class="form-group">
            <label>Frecuencia Card√≠aca (bpm)</label>
            <input type="number" id="eval-fc" value="75">
        </div>

        <div class="section-title">üèÉ ESTILO DE VIDA</div>
        <div class="form-group">
            <label>Actividad F√≠sica</label>
            <div class="toggle-group">
                <button type="button" class="toggle-btn active" onclick="toggleOption(this, 'actividad', 'si')">‚úÖ S√≠</button>
                <button type="button" class="toggle-btn" onclick="toggleOption(this, 'actividad', 'no')">‚ùå No</button>
            </div>
        </div>
        <div class="form-group">
            <label>Consumo de Frutas</label>
            <div class="toggle-group">
                <button type="button" class="toggle-btn active" onclick="toggleOption(this, 'frutas', 'si')">‚úÖ S√≠</button>
                <button type="button" class="toggle-btn" onclick="toggleOption(this, 'frutas', 'no')">‚ùå No</button>
            </div>
        </div>

        <div class="section-title">üè• ANTECEDENTES M√âDICOS</div>
        <div class="form-group">
            <label>Tiene Hipertensi√≥n</label>
            <div class="toggle-group">
                <button type="button" class="toggle-btn" onclick="toggleOption(this, 'hipertension', 'si')">S√≠</button>
                <button type="button" class="toggle-btn active" onclick="toggleOption(this, 'hipertension', 'no')">No</button>
            </div>
        </div>
        <div class="form-group">
            <label>Tiene Diabetes</label>
            <div class="toggle-group">
                <button type="button" class="toggle-btn" onclick="toggleOption(this, 'diabetes', 'si')">S√≠</button>
                <button type="button" class="toggle-btn active" onclick="toggleOption(this, 'diabetes', 'no')">No</button>
            </div>
        </div>

        <div class="section-title">üìä EVALUACI√ìN DE RIESGO</div>
        <div class="form-group">
            <label>Puntaje FINDRISC (0-26)</label>
            <input type="number" id="findrisc" min="0" max="26" value="12" required>
        </div>

        <button type="submit" class="btn btn-primary">üß¨ PREDECIR CON 7 MODELOS ML</button>
    </form>
</div>

<!-- PANTALLA 4: RESULTADOS ML -->
<div id="screen-results" class="screen">
    <div class="header">
        <button class="btn-secondary" onclick="showScreen('evaluation')" style="background: none; border: none; color: #00FF00; cursor: pointer;">‚Üê Volver</button>
        <h1>üìä Resultados ML</h1>
    </div>

    <div class="result-main">
        <div class="result-value" id="result-glucose">137.2<span style="font-size: 32px;"> mg/dL</span></div>
        <div class="category-badge category-prediabetes" id="result-category">Prediabetes</div>
        <div style="margin-top: 15px;">
            <span style="color: #B0B0B0;">Riesgo: </span>
            <strong style="color: #FFC107;" id="result-risk">Moderado</strong>
        </div>
        <div style="margin-top: 10px;">
            <span style="color: #B0B0B0;">Confianza: </span>
            <strong style="color: #4CAF50;" id="result-confidence">Alta (92%)</strong>
        </div>
    </div>

    <div class="card">
        <h3>M√©tricas de Precisi√≥n</h3>
        <p style="color: #B0B0B0; margin: 10px 0;">Error Esperado (MAE): <strong style="color: #FFF;">¬± 8.2 mg/dL</strong></p>
        <p style="color: #B0B0B0; margin: 10px 0;">Rango de Confianza: <strong style="color: #FFF;" id="result-range">129.0 - 145.4 mg/dL</strong></p>
    </div>

    <div class="chart-container" style="height: 400px;">
        <div class="chart-title">üß¨ Predicciones por Modelo ML</div>
        <canvas id="modelsChart"></canvas>
    </div>

    <div class="card">
        <h3>‚≠ê Modelo M√°s Acertado</h3>
        <p style="color: #00FF00; font-size: 20px; font-weight: bold; margin: 15px 0;" id="best-model">LightGBM</p>
        <p style="color: #B0B0B0;" id="model-description">Gradient Boosting optimizado para eficiencia y precisi√≥n</p>
    </div>

    <div class="recommendation">
        <h4 style="color: #FFC107; margin-bottom: 10px;">üí° Recomendaci√≥n</h4>
        <p id="recommendation-text">Glucosa predicha: 137.2 mg/dL (Prediabetes). Monitorear niveles y mantener estilo de vida saludable.</p>
    </div>

    <button class="btn" onclick="saveMLEvaluation()">üíæ Guardar en Historial</button>
    <button class="btn btn-secondary" onclick="showScreen('evaluation')">üîÑ Nueva Evaluaci√≥n</button>
</div>

<!-- PANTALLA 5: HISTORIAL -->
<div id="screen-history" class="screen">
    <div class="header">
        <button class="btn-secondary" onclick="showScreen('monitor')" style="background: none; border: none; color: #00FF00; cursor: pointer;">‚Üê Volver</button>
        <h1>üìä Historial</h1>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value" id="total-measurements">0</div>
            <div class="stat-label">Total Mediciones</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="avg-glucose">--</div>
            <div class="stat-label">Promedio Glucosa</div>
        </div>
    </div>

    <div class="card">
        <h3 style="margin-bottom: 15px;">Registros Recientes</h3>
        <div id="history-list">
            <div style="text-align: center; color: #B0B0B0; padding: 40px;">
                Sin registros a√∫n. Realiza una medici√≥n o evaluaci√≥n ML.
            </div>
        </div>
    </div>

    <button class="btn" onclick="exportHistoryCSV()">üì• Exportar Todo a CSV</button>
</div>

<!-- PANTALLA 6: REGISTRO DE SESI√ìN -->
<div id="screen-session" class="screen">
    <div class="header">
        <button class="btn-secondary" onclick="showScreen('monitor')" style="background: none; border: none; color: #00FF00; cursor: pointer;">‚Üê Volver</button>
        <h1>üìã Registro de Sesi√≥n</h1>
    </div>

    <div class="card">
        <h3>Informaci√≥n de Sesi√≥n</h3>
        <p style="color: #B0B0B0; margin: 10px 0;">ID: <strong style="color: #FFF;" id="session-id">--</strong></p>
        <p style="color: #B0B0B0; margin: 10px 0;">Inicio: <strong style="color: #FFF;" id="session-start">--</strong></p>
        <p style="color: #B0B0B0; margin: 10px 0;">Duraci√≥n: <strong style="color: #00FF00;" id="session-total-duration">00:00:00</strong></p>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value" id="session-measurements">0</div>
            <div class="stat-label">Mediciones</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="session-evaluations">0</div>
            <div class="stat-label">Evaluaciones ML</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="session-sensors">0/4</div>
            <div class="stat-label">Sensores Usados</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="session-errors">0</div>
            <div class="stat-label">Errores</div>
        </div>
    </div>

    <div class="section-title">‚è±Ô∏è L√≠nea de Tiempo</div>
    <div class="timeline" id="session-timeline">
        <!-- Timeline items will be added here -->
    </div>

    <button class="btn" onclick="exportSessionCSV()">üì• Exportar Registro (CSV)</button>
    <button class="btn btn-secondary" onclick="exportSessionJSON()">üì• Exportar Registro (JSON)</button>
</div>

<script>
// ==================== VARIABLES GLOBALES ====================
let currentScreen = 'monitor';
let sessionStartTime = new Date();
let sessionId = generateUUID();
let sessionEvents = [];
let historyData = [];
let lastMLResult = null;
let lastMeasurement = { spo2: 98, fc: 75 };

// Datos para formulario
let formData = {
    actividad: 'si',
    frutas: 'si',
    hipertension: 'no',
    diabetes: 'no'
};

// Charts
let glucoseChart, accelChart, gyroChart, modelsChart;

// Datos de sensores
let accelData = { x: [], y: [], z: [], labels: [] };
let gyroData = { alpha: [], beta: [], gamma: [], labels: [] };
let sensorActive = { accel: false, gyro: false };

// ==================== INICIALIZACI√ìN ====================
window.addEventListener('DOMContentLoaded', () => {
    initializeApp();
    logEvent('app_start', { version: '2.0', device: navigator.userAgent });
});

function initializeApp() {
    // Actualizar ID y fecha de sesi√≥n
    document.getElementById('session-id').textContent = sessionId.substring(0, 8);
    document.getElementById('session-start').textContent = formatDateTime(sessionStartTime);
    
    // Inicializar gr√°ficas
    initCharts();
    
    // Inicializar sensores
    initSensors();
    
    // Actualizar duraci√≥n de sesi√≥n cada segundo
    setInterval(updateSessionDuration, 1000);
    
    // Calcular IMC autom√°ticamente
    document.getElementById('peso').addEventListener('input', calculateIMC);
    document.getElementById('talla').addEventListener('input', calculateIMC);
    
    // Form submission
    document.getElementById('evaluationForm').addEventListener('submit', (e) => {
        e.preventDefault();
        predictWithML();
    });
    
    // Cargar historial del localStorage
    loadHistoryFromStorage();
    
    // Actualizar √∫ltima actualizaci√≥n
    setInterval(() => {
        document.getElementById('last-update').textContent = 'Hace ' + Math.floor((Date.now() - sessionStartTime) / 60000) + ' min';
    }, 60000);
}

// ==================== NAVEGACI√ìN ====================
function showScreen(screenName) {
    // Ocultar todas las pantallas
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    
    // Mostrar pantalla seleccionada
    document.getElementById('screen-' + screenName).classList.add('active');
    currentScreen = screenName;
    
    logEvent('screen_navigation', { from: currentScreen, to: screenName });
    
    // Actualizar gr√°ficas si es necesario
    if (screenName === 'monitor') {
        updateCharts();
    }
}

// ==================== GENERADOR UUID ====================
function generateUUID() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0;
        const v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
}

// ==================== FORMATO FECHA ====================
function formatDateTime(date) {
    const d = new Date(date);
    const pad = (n) => n < 10 ? '0' + n : n;
    return `${pad(d.getDate())}/${pad(d.getMonth() + 1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}

function formatTime(seconds) {
    const h = Math.floor(seconds / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    const s = seconds % 60;
    return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
}

// ==================== DURACI√ìN DE SESI√ìN ====================
function updateSessionDuration() {
    const duration = Math.floor((Date.now() - sessionStartTime) / 1000);
    const formatted = formatTime(duration);
    document.getElementById('session-duration').textContent = formatted;
    document.getElementById('session-total-duration').textContent = formatted;
}

// ==================== REGISTRO DE EVENTOS ====================
function logEvent(type, data) {
    const event = {
        timestamp: new Date().toISOString(),
        type: type,
        data: data
    };
    sessionEvents.push(event);
    updateSessionTimeline();
    updateSessionStats();
}

function updateSessionTimeline() {
    const timeline = document.getElementById('session-timeline');
    const lastEvents = sessionEvents.slice(-10).reverse();
    
    timeline.innerHTML = lastEvents.map(event => {
        const time = new Date(event.timestamp).toLocaleTimeString();
        let icon = 'üìã';
        let desc = event.type;
        
        switch(event.type) {
            case 'app_start': icon = 'üöÄ'; desc = 'Aplicaci√≥n iniciada'; break;
            case 'sensor_activated': icon = 'üì±'; desc = `Sensor ${event.data.sensor} activado`; break;
            case 'measurement_complete': icon = 'üì∏'; desc = 'Medici√≥n completada'; break;
            case 'ml_evaluation_complete': icon = 'üß¨'; desc = 'Evaluaci√≥n ML completada'; break;
            case 'screen_navigation': icon = 'üìä'; desc = `Navegaci√≥n: ${event.data.from} ‚Üí ${event.data.to}`; break;
        }
        
        return `
            <div class="timeline-item">
                <div class="timeline-time">${icon} ${time}</div>
                <div class="timeline-desc">${desc}</div>
            </div>
        `;
    }).join('');
}

function updateSessionStats() {
    const measurements = sessionEvents.filter(e => e.type === 'measurement_complete').length;
    const evaluations = sessionEvents.filter(e => e.type === 'ml_evaluation_complete').length;
    const errors = sessionEvents.filter(e => e.type === 'error_occurred').length;
    
    document.getElementById('session-measurements').textContent = measurements;
    document.getElementById('session-evaluations').textContent = evaluations;
    document.getElementById('session-errors').textContent = errors;
}

// ==================== INICIALIZAR GR√ÅFICAS ====================
function initCharts() {
    // Gr√°fica de Glucosa
    const ctxGlucose = document.getElementById('glucoseChart').getContext('2d');
    glucoseChart = new Chart(ctxGlucose, {
        type: 'line',
        data: {
            labels: ['00:00', '04:00', '08:00', '12:00', '16:00', '20:00', '23:59'],
            datasets: [{
                label: 'Glucosa',
                data: [115, 118, 125, 140, 135, 130, 137],
                borderColor: '#00FF00',
                backgroundColor: 'rgba(0, 255, 0, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: false,
                    min: 80,
                    max: 160,
                    ticks: { color: '#B0B0B0' },
                    grid: { color: '#333333' }
                },
                x: {
                    ticks: { color: '#B0B0B0' },
                    grid: { color: '#333333' }
                }
            }
        }
    });

    // Gr√°fica de Aceler√≥metro
    const ctxAccel = document.getElementById('accelChart').getContext('2d');
    accelChart = new Chart(ctxAccel, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                {
                    label: 'X',
                    data: [],
                    borderColor: '#FF5252',
                    backgroundColor: 'rgba(255, 82, 82, 0.1)',
                    tension: 0.4
                },
                {
                    label: 'Y',
                    data: [],
                    borderColor: '#2196F3',
                    backgroundColor: 'rgba(33, 150, 243, 0.1)',
                    tension: 0.4
                },
                {
                    label: 'Z',
                    data: [],
                    borderColor: '#4CAF50',
                    backgroundColor: 'rgba(76, 175, 80, 0.1)',
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: true, labels: { color: '#B0B0B0' } }
            },
            scales: {
                y: {
                    min: -20,
                    max: 20,
                    ticks: { color: '#B0B0B0' },
                    grid: { color: '#333333' }
                },
                x: {
                    display: false
                }
            }
        }
    });

    // Gr√°fica de Giroscopio
    const ctxGyro = document.getElementById('gyroChart').getContext('2d');
    gyroChart = new Chart(ctxGyro, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                {
                    label: 'Alpha',
                    data: [],
                    borderColor: '#FF9800',
                    backgroundColor: 'rgba(255, 152, 0, 0.1)',
                    tension: 0.4
                },
                {
                    label: 'Beta',
                    data: [],
                    borderColor: '#9C27B0',
                    backgroundColor: 'rgba(156, 39, 176, 0.1)',
                    tension: 0.4
                },
                {
                    label: 'Gamma',
                    data: [],
                    borderColor: '#00BCD4',
                    backgroundColor: 'rgba(0, 188, 212, 0.1)',
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: true, labels: { color: '#B0B0B0' } }
            },
            scales: {
                y: {
                    min: -180,
                    max: 180,
                    ticks: { color: '#B0B0B0' },
                    grid: { color: '#333333' }
                },
                x: {
                    display: false
                }
            }
        }
    });
}

function updateCharts() {
    if (glucoseChart) glucoseChart.update();
    if (accelChart) accelChart.update();
    if (gyroChart) gyroChart.update();
}

// ==================== SENSORES ====================
function initSensors() {
    // Aceler√≥metro
    if (window.DeviceMotionEvent) {
        window.addEventListener('devicemotion', handleAccelerometer);
        sensorActive.accel = true;
        logEvent('sensor_activated', { sensor: 'accelerometer' });
    }
    
    // Giroscopio
    if (window.DeviceOrientationEvent) {
        // Para iOS 13+, necesita permiso expl√≠cito
        if (typeof DeviceOrientationEvent.requestPermission === 'function') {
            DeviceOrientationEvent.requestPermission()
                .then(permission => {
                    if (permission === 'granted') {
                        window.addEventListener('deviceorientation', handleGyroscope);
                        sensorActive.gyro = true;
                        logEvent('sensor_activated', { sensor: 'gyroscope' });
                    }
                });
        } else {
            window.addEventListener('deviceorientation', handleGyroscope);
            sensorActive.gyro = true;
            logEvent('sensor_activated', { sensor: 'gyroscope' });
        }
    }
    
    // Actualizar conteo de sensores
    updateSensorCount();
}

function handleAccelerometer(event) {
    const x = event.accelerationIncludingGravity.x || 0;
    const y = event.accelerationIncludingGravity.y || 0;
    const z = event.accelerationIncludingGravity.z || 0;
    
    // Limitar a 30 puntos
    if (accelData.x.length > 30) {
        accelData.x.shift();
        accelData.y.shift();
        accelData.z.shift();
        accelData.labels.shift();
    }
    
    accelData.x.push(x.toFixed(2));
    accelData.y.push(y.toFixed(2));
    accelData.z.push(z.toFixed(2));
    accelData.labels.push('');
    
    // Actualizar gr√°fica cada segundo
    if (accelChart && accelData.x.length % 10 === 0) {
        accelChart.data.labels = accelData.labels;
        accelChart.data.datasets[0].data = accelData.x;
        accelChart.data.datasets[1].data = accelData.y;
        accelChart.data.datasets[2].data = accelData.z;
        accelChart.update('none');
    }
}

function handleGyroscope(event) {
    const alpha = event.alpha || 0;
    const beta = event.beta || 0;
    const gamma = event.gamma || 0;
    
    // Limitar a 30 puntos
    if (gyroData.alpha.length > 30) {
        gyroData.alpha.shift();
        gyroData.beta.shift();
        gyroData.gamma.shift();
        gyroData.labels.shift();
    }
    
    gyroData.alpha.push(alpha.toFixed(2));
    gyroData.beta.push(beta.toFixed(2));
    gyroData.gamma.push(gamma.toFixed(2));
    gyroData.labels.push('');
    
    // Actualizar gr√°fica cada segundo
    if (gyroChart && gyroData.alpha.length % 10 === 0) {
        gyroChart.data.labels = gyroData.labels;
        gyroChart.data.datasets[0].data = gyroData.alpha;
        gyroChart.data.datasets[1].data = gyroData.beta;
        gyroChart.data.datasets[2].data = gyroData.gamma;
        gyroChart.update('none');
    }
}

function updateSensorCount() {
    let activeCount = 0;
    if (sensorActive.accel) activeCount++;
    if (sensorActive.gyro) activeCount++;
    document.getElementById('session-sensors').textContent = `${activeCount}/4`;
}

// ==================== CAPTURA DE SPO2/FC ====================
function startCapture() {
    logEvent('measurement_start', {});
    
    // Ocultar bot√≥n de inicio
    document.getElementById('btnStartCapture').style.display = 'none';
    
    // Intentar acceder a la c√°mara
    navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
        .then(stream => {
            const video = document.getElementById('videoPreview');
            video.srcObject = stream;
            video.style.display = 'block';
            
            // Mostrar countdown
            document.getElementById('captureCountdown').style.display = 'block';
            
            let countdown = 10;
            const interval = setInterval(() => {
                countdown--;
                document.getElementById('countdownNumber').textContent = countdown;
                document.getElementById('captureProgress').style.width = ((10 - countdown) * 10) + '%';
                
                if (countdown <= 0) {
                    clearInterval(interval);
                    completeCapture(stream);
                }
            }, 1000);
        })
        .catch(err => {
            alert('No se pudo acceder a la c√°mara. Por favor verifica los permisos.');
            document.getElementById('btnStartCapture').style.display = 'block';
            logEvent('error_occurred', { type: 'camera_access', message: err.message });
        });
}

function completeCapture(stream) {
    // Detener c√°mara
    stream.getTracks().forEach(track => track.stop());
    document.getElementById('videoPreview').style.display = 'none';
    document.getElementById('captureCountdown').style.display = 'none';
    
    // Simular resultados (en producci√≥n, aqu√≠ ir√≠a el an√°lisis real)
    const spo2 = 95 + Math.floor(Math.random() * 5);
    const fc = 70 + Math.floor(Math.random() * 20);
    
    lastMeasurement = { spo2, fc, timestamp: new Date() };
    
    document.getElementById('measured-spo2').textContent = spo2;
    document.getElementById('measured-fc').textContent = fc;
    document.getElementById('measurement-time').textContent = formatDateTime(new Date());
    
    // Mostrar resultados
    document.getElementById('captureResults').style.display = 'block';
    document.getElementById('btnSaveMeasurement').style.display = 'block';
    
    // Actualizar display principal
    document.getElementById('spo2-display').textContent = spo2 + '%';
    document.getElementById('fc-display').textContent = fc + ' bpm';
    
    // Auto-rellenar en formulario de evaluaci√≥n
    document.getElementById('eval-spo2').value = spo2;
    document.getElementById('eval-fc').value = fc;
    
    logEvent('measurement_complete', { spo2, fc });
}

function saveMeasurement() {
    const measurement = {
        id: generateUUID(),
        type: 'measurement',
        timestamp: new Date().toISOString(),
        data: lastMeasurement
    };
    
    historyData.push(measurement);
    saveHistoryToStorage();
    updateHistoryDisplay();
    
    alert('‚úÖ Medici√≥n guardada en historial');
    logEvent('data_saved', { type: 'measurement' });
}

// ==================== FORMULARIO ML ====================
function calculateIMC() {
    const peso = parseFloat(document.getElementById('peso').value);
    const talla = parseFloat(document.getElementById('talla').value);
    
    if (peso && talla && talla > 0) {
        const imc = (peso / (talla * talla)).toFixed(2);
        document.getElementById('imc').value = imc;
    }
}

function toggleOption(btn, field, value) {
    // Remover active de todos los botones del grupo
    btn.parentElement.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
    // Activar el clickeado
    btn.classList.add('active');
    // Guardar valor
    formData[field] = value;
}

// ==================== PREDICCI√ìN ML ====================
async function predictWithML() {
    const btn = document.querySelector('#evaluationForm button[type="submit"]');
    btn.disabled = true;
    btn.innerHTML = '<div class="spinner"></div> Consultando API...';
    
    const data = {
        Edad: parseInt(document.getElementById('edad').value),
        Sexo: document.getElementById('sexo').value,
        Peso: parseFloat(document.getElementById('peso').value),
        Talla: parseFloat(document.getElementById('talla').value),
        IMC: parseFloat(document.getElementById('imc').value),
        Perimetro_Cintura: parseInt(document.getElementById('cintura').value),
        SpO2: parseInt(document.getElementById('eval-spo2').value),
        Frecuencia_Cardiaca: parseInt(document.getElementById('eval-fc').value),
        Actividad_Fisica: formData.actividad,
        Consumo_Frutas: formData.frutas,
        Tiene_Hipertension: formData.hipertension === 'si' ? 'Si' : 'No',
        Tiene_Diabetes: formData.diabetes === 'si' ? 'Si' : 'No',
        Puntaje_FINDRISC: parseInt(document.getElementById('findrisc').value)
    };
    
    logEvent('ml_evaluation_start', { data });
    
    try {
        const response = await fetch('https://stringed-ericka-vertically.ngrok-free.dev/predict', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        if (!response.ok) throw new Error('API Error');
        
        const result = await response.json();
        lastMLResult = result;
        
        displayMLResults(result);
        showScreen('results');
        
        logEvent('ml_evaluation_complete', { success: true, result });
        
    } catch (error) {
        alert('‚ùå Error al conectar con la API. Verifica que el servidor est√© activo.');
        logEvent('error_occurred', { type: 'api_error', message: error.message });
    } finally {
        btn.disabled = false;
        btn.innerHTML = 'üß¨ PREDECIR CON 7 MODELOS ML';
    }
}

function displayMLResults(result) {
    // Resultado principal
    document.getElementById('result-glucose').innerHTML = result.glucosa_predicha + '<span style="font-size: 32px;"> mg/dL</span>';
    document.getElementById('result-category').textContent = result.categoria;
    document.getElementById('result-category').className = 'category-badge category-' + result.categoria.toLowerCase();
    document.getElementById('result-risk').textContent = result.riesgo;
    document.getElementById('result-confidence').textContent = 'Alta (' + (result.confianza * 100) + '%)';
    
    // Rango
    const min = result.rango_confianza.min;
    const max = result.rango_confianza.max;
    document.getElementById('result-range').textContent = `${min} - ${max} mg/dL`;
    
    // Modelo m√°s acertado
    document.getElementById('best-model').textContent = result.modelo_mas_acertado;
    
    // Recomendaci√≥n
    document.getElementById('recommendation-text').textContent = result.recomendacion;
    
    // Crear gr√°fica de modelos
    createModelsChart(result.predicciones_por_modelo, result.modelo_mas_acertado);
}

function createModelsChart(predictions, bestModel) {
    const ctx = document.getElementById('modelsChart').getContext('2d');
    
    if (modelsChart) {
        modelsChart.destroy();
    }
    
    const labels = Object.keys(predictions);
    const data = Object.values(predictions);
    
    modelsChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Glucosa Predicha (mg/dL)',
                data: data,
                backgroundColor: labels.map(label => label === bestModel ? '#00FF00' : '#4CAF50'),
                borderColor: '#00FF00',
                borderWidth: 2
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                title: { display: false }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    ticks: { color: '#B0B0B0' },
                    grid: { color: '#333333' }
                },
                y: {
                    ticks: { color: '#B0B0B0' },
                    grid: { color: '#333333' }
                }
            }
        }
    });
}

function saveMLEvaluation() {
    if (!lastMLResult) return;
    
    const evaluation = {
        id: generateUUID(),
        type: 'ml_evaluation',
        timestamp: new Date().toISOString(),
        data: lastMLResult
    };
    
    historyData.push(evaluation);
    saveHistoryToStorage();
    updateHistoryDisplay();
    
    alert('‚úÖ Evaluaci√≥n guardada en historial');
    logEvent('data_saved', { type: 'ml_evaluation' });
}

// ==================== HISTORIAL ====================
function loadHistoryFromStorage() {
    const stored = localStorage.getItem('glucose_history');
    if (stored) {
        historyData = JSON.parse(stored);
        updateHistoryDisplay();
    }
}

function saveHistoryToStorage() {
    localStorage.setItem('glucose_history', JSON.stringify(historyData));
}

function updateHistoryDisplay() {
    const list = document.getElementById('history-list');
    
    if (historyData.length === 0) {
        list.innerHTML = '<div style="text-align: center; color: #B0B0B0; padding: 40px;">Sin registros a√∫n.</div>';
        document.getElementById('total-measurements').textContent = '0';
        document.getElementById('avg-glucose').textContent = '--';
        return;
    }
    
    // Actualizar stats
    document.getElementById('total-measurements').textContent = historyData.length;
    
    const glucoseValues = historyData
        .filter(item => item.type === 'ml_evaluation')
        .map(item => item.data.glucosa_predicha);
    
    if (glucoseValues.length > 0) {
        const avg = (glucoseValues.reduce((a, b) => a + b, 0) / glucoseValues.length).toFixed(1);
        document.getElementById('avg-glucose').textContent = avg;
    }
    
    // Mostrar √∫ltimos 10
    const recent = historyData.slice(-10).reverse();
    list.innerHTML = recent.map(item => {
        const date = new Date(item.timestamp);
        const dateStr = formatDateTime(date);
        
        if (item.type === 'measurement') {
            return `
                <div class="history-item">
                    <div>
                        <div class="history-date">${dateStr}</div>
                        <div class="badge badge-spo2">SpO2/FC</div>
                    </div>
                    <div class="history-data">
                        SpO2: ${item.data.spo2}% | FC: ${item.data.fc} bpm
                    </div>
                </div>
            `;
        } else {
            return `
                <div class="history-item">
                    <div>
                        <div class="history-date">${dateStr}</div>
                        <div class="badge badge-ml">Evaluaci√≥n ML</div>
                    </div>
                    <div class="history-data">
                        ${item.data.glucosa_predicha} mg/dL | ${item.data.categoria}
                    </div>
                </div>
            `;
        }
    }).join('');
}

function exportHistoryCSV() {
    if (historyData.length === 0) {
        alert('No hay datos para exportar');
        return;
    }
    
    let csv = 'Fecha,Tipo,SpO2,FC,Glucosa,Categoria\n';
    
    historyData.forEach(item => {
        const date = new Date(item.timestamp).toLocaleString();
        if (item.type === 'measurement') {
            csv += `${date},Medici√≥n,${item.data.spo2},${item.data.fc},,\n`;
        } else {
            csv += `${date},Evaluaci√≥n ML,,,${item.data.glucosa_predicha},${item.data.categoria}\n`;
        }
    });
    
    downloadFile(csv, 'historial_glucose_ml.csv', 'text/csv');
    logEvent('data_exported', { type: 'history_csv', records: historyData.length });
}

// ==================== EXPORTAR SESI√ìN ====================
function exportSessionCSV() {
    let csv = 'Timestamp,Tipo,Descripcion\n';
    
    sessionEvents.forEach(event => {
        const time = new Date(event.timestamp).toLocaleString();
        const type = event.type;
        const desc = JSON.stringify(event.data).replace(/"/g, '""');
        csv += `${time},${type},"${desc}"\n`;
    });
    
    downloadFile(csv, `session_${sessionId}.csv`, 'text/csv');
    logEvent('data_exported', { type: 'session_csv', events: sessionEvents.length });
}

function exportSessionJSON() {
    const session = {
        id: sessionId,
        startTime: sessionStartTime.toISOString(),
        duration: Math.floor((Date.now() - sessionStartTime) / 1000),
        device: navigator.userAgent,
        events: sessionEvents
    };
    
    const json = JSON.stringify(session, null, 2);
    downloadFile(json, `session_${sessionId}.json`, 'application/json');
    logEvent('data_exported', { type: 'session_json', events: sessionEvents.length });
}

// ==================== DOWNLOAD FILE ====================
function downloadFile(content, filename, type) {
    const blob = new Blob([content], { type: type });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// ==================== SERVICE WORKER ====================
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js').catch(() => {});
}
</script>

</body>
</html>